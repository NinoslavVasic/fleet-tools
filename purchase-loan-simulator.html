<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchase Loan Simulator â€“ Piece of Cake</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f9f9fb;color:#333;}
    body::before{
      content:'';position:fixed;top:0;left:0;width:100%;height:100%;
      background:url('https://mypieceofcakemove.com/wp-content/uploads/2022/02/piece-of-cake-moving-and-storage-media-moving-truck-in-brooklyn.jpg')
      center/cover no-repeat;opacity:.1;z-index:-1;
    }
    .container{max-width:960px;margin:auto;background:rgba(255,255,255,.96);
      padding:30px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.12);backdrop-filter:blur(6px);}
    .header{text-align:center;margin-bottom:25px;}
    .header img{width:260px;height:auto;margin-bottom:12px;}
    h2{color:#2c3e50;}
    .row{display:flex;flex-wrap:wrap;gap:20px;}
    .col{flex:1;min-width:280px;}
    .input-group{margin:14px 0;}
    label{font-weight:bold;color:#34495e;display:block;margin-bottom:6px;}
    input,select{padding:10px;font-size:16px;border:1px solid #ddd;border-radius:6px;
      border-left:4px solid #FF6B00;}
    button{margin-top:20px;padding:12px 24px;background:#FF6B00;color:#fff;
      border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
    button:hover{background:#E55A00;}
    button:disabled{background:#ccc;cursor:not-allowed;}
    .error{color:#e74c3c;font-weight:bold;margin:15px 0;text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:15px;}
    th{background:#FF6B00;color:#fff;padding:12px;text-align:left;}
    td{padding:10px 12px;border-bottom:1px solid #eee;}
    .best{background:#d4edda !important;font-weight:bold;}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:30px;}
    .chart-container{background:#fff;padding:15px;border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .attribution{text-align:center;margin-top:40px;font-size:12px;color:#666;
      border-top:1px solid #ddd;padding-top:15px;}
    .attribution a{color:#FF6B00;text-decoration:none;}
    @media(max-width:768px){.row,.charts{flex-direction:column;grid-template-columns:1fr;}}
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="https://mypieceofcakemove.com/wp-content/uploads/2023/05/Piece-of-Cake-Moving-NYC-Best-Mover-Moving-Company.jpg"
         alt="Piece of Cake Logo">
    <h2>Purchase Loan Simulator</h2>
  </div>

  <div class="row">
    <div class="col">
      <h4>Core Parameters</h4>
      <div class="input-group"><label>Truck Value ($)</label>
        <input type="number" id="truck-value" value="129475" step="1000" min="1"></div>
      <div class="input-group"><label>Term (months)</label>
        <input type="number" id="term" value="30" min="1"></div>
      <div class="input-group"><label>Annual Interest Rate (%)</label>
        <input type="number" id="interest-rate" value="0" step="0.1" min="0"
               placeholder="Enter 0 to calculate from payment"></div>
      <div class="input-group"><label>Sales Tax Rate (%)</label>
        <input type="number" id="sales-tax" value="0" step="0.01" min="0"></div>
      <div class="input-group"><label>Residual Value ($)</label>
        <input type="number" id="residual" value="0" min="0"></div>
      <div class="input-group"><label>Down Payment ($)</label>
        <input type="number" id="down-payment" value="4624.85" min="0"></div>
      <div class="input-group"><label>Predefined Monthly Payment ($)</label>
        <input type="number" id="predefined-payment" value="4624.85" placeholder="Leave blank to calculate" min="0"></div>
    </div>
  </div>

  <div style="text-align:center;">
    <button onclick="run()">Calculate</button>
    <button id="pdf-btn" onclick="exportPDF()" disabled>Export PDF</button>
  </div>

  <div id="error" class="error"></div>

  <div id="results" style="display:none;">
    <h3>Purchase Loan Summary</h3>
    <table id="summary-table">
      <thead><tr>
        <th>Option</th><th>Down Payment</th><th>Monthly Payment</th>
        <th>Total Payments</th><th>Residual Benefit</th><th>Net Cost</th>
        <th>NPV @ <span id="npv-rate"></span>%</th>
      </tr></thead>
      <tbody></tbody>
    </table>

    <div class="charts">
      <div class="chart-container"><canvas id="chart-monthly"></canvas></div>
      <div class="chart-container"><canvas id="chart-npv"></canvas></div>
      <div class="chart-container"><canvas id="chart-cumulative"></canvas></div>
      <div class="chart-container"><canvas id="chart-netcost"></canvas></div>
    </div>
  </div>

  <div class="attribution">
    Powered by <a href="https://mypieceofcakemove.com" target="_blank">Piece of Cake Moving & Storage</a>
  </div>
</div>

<script>
/* ---------- PurchaseLoanSimulator (Exact Python Port) ---------- */
class PurchaseLoanSimulator {
  constructor(truck_value, term, annual_interest_rate, sales_tax, residual_value) {
    if (truck_value <= 0 || term <= 0 || residual_value < 0)
      throw new Error("Truck value & term must be >0; residual >=0");
    if (annual_interest_rate < 0 || sales_tax < 0)
      throw new Error("Rates cannot be negative");

    this.truck_value = truck_value;
    this.term = term;
    this.annual_rate = annual_interest_rate;
    this.monthly_rate = annual_interest_rate / 12;
    this.sales_tax = sales_tax;
    this.residual_value = residual_value;
    this.calculated_rate = null;
  }

  pmt(principal, rate, periods) {
    if (rate === 0) return principal / periods;
    return (principal * rate * Math.pow(1 + rate, periods)) /
           (Math.pow(1 + rate, periods) - 1);
  }

  // Brent's method approximation for implied rate
  calculate_implied_interest_rate(predefined_payment, principal, periods) {
    const tolerance = 1e-8;
    let low = 0, high = 1;
    while (this.pmt(principal, high, periods) < predefined_payment) high *= 2;
    for (let i = 0; i < 100; i++) {
      const mid = (low + high) / 2;
      const payment = this.pmt(principal, mid, periods);
      if (Math.abs(payment - predefined_payment) < tolerance) return mid * 12;
      if (payment < predefined_payment) low = mid;
      else high = mid;
    }
    return (low + high) / 2 * 12; // approx
  }

  purchase_loan(predefined_payment = null, down_payment = 0) {
    const tax_amount = this.truck_value * this.sales_tax;
    const total_loan = this.truck_value + tax_amount - down_payment;
    if (total_loan < 0) throw new Error("Down payment exceeds truck + tax");

    let monthly_payment;
    if (predefined_payment !== null) {
      monthly_payment = predefined_payment;
      if (this.annual_rate === 0) {
        this.calculated_rate = this.calculate_implied_interest_rate(predefined_payment, total_loan, this.term);
        this.monthly_rate = this.calculated_rate / 12;
        this.annual_rate = this.calculated_rate;
      }
    } else {
      monthly_payment = this.pmt(total_loan, this.monthly_rate, this.term);
    }

    const cf = new Array(this.term + 1).fill(0);
    cf[0] = -down_payment;
    for (let i = 1; i <= this.term; i++) cf[i] = -monthly_payment;
    cf[this.term] += this.residual_value;

    return { monthly_payment, cf };
  }

  npv(cash_flows, discount_rate = this.annual_rate) {
    const monthly = discount_rate / 12;
    return cash_flows.reduce((sum, cf, i) => sum + cf / Math.pow(1 + monthly, i), 0);
  }

  run_analysis(predefined_payment = null, down_payment = 0) {
    const { monthly_payment, cf } = this.purchase_loan(predefined_payment, down_payment);
    const npv = this.npv(cf);
    return { monthly_payment, cf, npv, down_payment };
  }

  summary_table(results) {
    const monthly = results.monthly_payment;
    const down = results.down_payment;
    const total = monthly * this.term + down;
    const residual_benefit = this.residual_value;
    const net = total - residual_benefit;
    const npv = results.npv;

    return [{
      option: 'Purchase Loan',
      down, monthly, total, residual_benefit, net, npv
    }];
  }
}

/* ---------- UI & Charts ---------- */
let simulator, lastResult, chartObjs = {};

function run() {
  const err = document.getElementById('error');
  err.textContent = '';
  document.getElementById('results').style.display = 'none';
  document.getElementById('pdf-btn').disabled = true;

  try {
    const inputs = {
      truck_value: parseFloat(document.getElementById('truck-value').value),
      term: parseInt(document.getElementById('term').value),
      annual_rate: parseFloat(document.getElementById('interest-rate').value) / 100,
      sales_tax: parseFloat(document.getElementById('sales-tax').value) / 100,
      residual: parseFloat(document.getElementById('residual').value),
      down: parseFloat(document.getElementById('down-payment').value) || 0,
      predefined: document.getElementById('predefined-payment').value
        ? parseFloat(document.getElementById('predefined-payment').value) : null
    };

    simulator = new PurchaseLoanSimulator(
      inputs.truck_value, inputs.term, inputs.annual_rate,
      inputs.sales_tax, inputs.residual
    );

    lastResult = simulator.run_analysis(inputs.predefined, inputs.down);
    renderResults(lastResult, simulator.annual_rate);
    document.getElementById('pdf-btn').disabled = false;
  } catch (e) {
    err.textContent = e.message;
  }
}

function renderResults(res, annual_rate) {
  const data = simulator.summary_table(res)[0];
  const tbody = document.querySelector('#summary-table tbody');
  tbody.innerHTML = '';
  const row = document.createElement('tr');
  row.className = 'best';
  row.innerHTML = `
    <td>${data.option}</td>
    <td>$${data.down.toFixed(2)}</td>
    <td>$${data.monthly.toFixed(2)}</td>
    <td>$${data.total.toFixed(2)}</td>
    <td>$${data.residual_benefit.toFixed(2)}</td>
    <td>$${data.net.toFixed(2)}</td>
    <td>$${data.npv.toFixed(2)}</td>
  `;
  tbody.appendChild(row);
  document.getElementById('npv-rate').textContent = (annual_rate*100).toFixed(1);
  document.getElementById('results').style.display = 'block';

  // Charts
  const months = Array.from({length: simulator.term + 1}, (_,i)=>i);
  const cum = res.cf.reduce((a,c,i)=> (a[i]= (a[i-1]||0)+c, a), []);
  const colors = ['#2E86AB'];

  destroyCharts();
  chartObjs.monthly = new Chart(document.getElementById('chart-monthly'), {
    type:'bar', data:{labels:['Purchase Loan'], datasets:[{label:'Monthly ($)', data:[data.monthly], backgroundColor:colors}]},
    options:{responsive:true,plugins:{title:{display:true,text:'Monthly Payment'}}}
  });
  chartObjs.npv = new Chart(document.getElementById('chart-npv'), {
    type:'bar', data:{labels:['Purchase Loan'], datasets:[{label:'NPV ($)', data:[data.npv], backgroundColor:colors}]},
    options:{responsive:true,plugins:{title:{display:true,text:'Net Present Value'}}}
  });
  chartObjs.cumulative = new Chart(document.getElementById('chart-cumulative'), {
    type:'line', data:{labels:months, datasets:[{label:'Purchase Loan', data:cum, borderColor:colors[0], fill:false}]},
    options:{responsive:true,plugins:{title:{display:true,text:'Cumulative Cash Flow'}}}
  });
  chartObjs.netcost = new Chart(document.getElementById('chart-netcost'), {
    type:'bar', data:{labels:['Purchase Loan'], datasets:[{label:'Net Cost ($)', data:[data.net], backgroundColor:colors}]},
    options:{responsive:true,plugins:{title:{display:true,text:`${simulator.term/12}-Year Net Cost`}}}
  });
}

function destroyCharts() {
  Object.values(chartObjs).forEach(c=>c&&c.destroy());
  chartObjs = {};
}

/* ---------- PDF Export ---------- */
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pageW = pdf.internal.pageSize.getWidth();

  const hidden = document.createElement('div');
  hidden.style.position = 'absolute'; hidden.style.left = '-9999px';
  hidden.innerHTML = `
    <div style="text-align:center;padding:20px;">
      <img src="https://mypieceofcakemove.com/wp-content/uploads/2023/05/Piece-of-Cake-Moving-NYC-Best-Mover-Moving-Company.jpg" width="200"/>
      <h2 style="margin:10px 0;">Purchase Loan Analysis â€“ ${simulator.term/12} Year</h2>
      <p>Generated ${new Date().toLocaleDateString()}</p>
    </div>
    ${document.querySelector('#summary-table').outerHTML}
    <div style="margin-top:30px;display:grid;grid-template-columns:1fr 1fr;gap:15px;">
      ${await Promise.all(Object.values(chartObjs).map(c=>c.toBase64Image())).then(imgs=>
        imgs.map(src=>`<img src="${src}" style="width:100%;"/>`).join(''))}
    </div>
  `;
  document.body.appendChild(hidden);
  const canvas = await html2canvas(hidden,{scale:2});
  document.body.removeChild(hidden);

  const imgData = canvas.toDataURL('image/png');
  const imgH = (canvas.height * pageW) / canvas.width;
  pdf.addImage(imgData,'PNG',0,0,pageW,imgH);
  pdf.save(`PurchaseLoan_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>
</body>
</html>