<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truck Financing Calculator - Piece of Cake Moving & Storage</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9fb;
      color: #333;
      position: relative;
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://mypieceofcakemove.com/wp-content/uploads/2022/02/piece-of-cake-moving-and-storage-media-moving-truck-in-brooklyn.jpg') center/cover no-repeat;
      opacity: 0.12;
      z-index: -2;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.96);
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
    }
    .header {
      text-align: center;
      margin-bottom: 25px;
    }
    .header img {
      width: 260px;
      height: auto;
      margin-bottom: 12px;
    }
    h2, h3, h4 {
      color: #2c3e50;
      margin-top: 20px;
    }
    h3, h4 { color: #FF6B00; }
    .input-group {
      margin: 14px 0;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 6px;
      color: #34495e;
    }
    input, select {
      padding: 11px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      border-left: 4px solid #FF6B00;
    }
    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 280px;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 25px 0;
    }
    button {
      padding: 12px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    .btn-calculate { background: #FF6B00; color: white; }
    .btn-calculate:hover { background: #E55A00; }
    .btn-pdf { background: #28a745; color: white; }
    .btn-pdf:hover { background: #218838; }
    .btn-email { background: #007bff; color: white; }
    .btn-email:hover { background: #0069d9; }
    .btn-print { background: #6c757d; color: white; }
    .btn-print:hover { background: #5a6268; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    .error { color: #e74c3c; font-weight: bold; text-align: center; margin: 15px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
    th { background: #FF6B00; color: white; padding: 12px; text-align: left; }
    td { padding: 10px 12px; border-bottom: 1px solid #eee; }
    tr:hover { background: #fff8f0; }
    .best { background: #d4edda !important; font-weight: bold; }

    .charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }
    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .attribution {
      text-align: center;
      margin-top: 40px;
      font-size: 12px;
      color: #666;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .attribution a { color: #FF6B00; text-decoration: none; }

    #pdf-content, #print-content { display: none; background: white; padding: 40px; }
    @media (max-width: 992px) { .charts { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .row, .btn-group { flex-direction: column; } .header img { width: 200px; } }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="https://mypieceofcakemove.com/wp-content/uploads/2023/05/Piece-of-Cake-Moving-NYC-Best-Mover-Moving-Company.jpg" alt="Piece of Cake Logo" />
    <h2>Truck Financing Calculator</h2>
  </div>

  <div class="row">
    <div class="col">
      <h4>Core Parameters</h4>
      <div class="input-group">
        <label>Truck Value ($)</label>
        <input type="number" id="truck-value" value="100000" step="1000" min="1">
      </div>
      <div class="input-group">
        <label>Term (months)</label>
        <input type="number" id="term" value="60" min="1" max="120">
      </div>
      <div class="input-group">
        <label>Annual Interest Rate (%)</label>
        <input type="number" id="interest-rate" value="7" step="0.1" min="0">
      </div>
      <div class="input-group">
        <label>Sales Tax Rate (%)</label>
        <input type="number" id="sales-tax" value="6.625" step="0.01" min="0">
      </div>
      <div class="input-group">
        <label>Residual Value ($)</label>
        <input type="number" id="residual" value="30000" min="0">
      </div>
      <div class="input-group">
        <label>Lessor Margin (%)</label>
        <input type="number" id="lessor-margin" value="0.15" step="0.01" min="0">
      </div>
      <div class="input-group">
        <label>Finance Lease Residual as Benefit?</label>
        <select id="residual-benefit">
          <option value="true">Yes (Resale Benefit)</option>
          <option value="false">No (Buyout Cost)</option>
        </select>
      </div>
    </div>

    <div class="col">
      <h4>Down Payments ($)</h4>
      <div class="input-group">
        <label>Purchase</label>
        <input type="number" id="down-purchase" value="0" min="0">
      </div>
      <div class="input-group">
        <label>Finance Lease</label>
        <input type="number" id="down-finance" value="0" min="0">
      </div>
      <div class="input-group">
        <label>Operational Lease</label>
        <input type="number" id="down-operational" value="0" min="0">
      </div>

      <h4 style="margin-top: 30px;">Predefined Monthly Payments (optional)</h4>
      <div class="input-group">
        <label>Purchase</label>
        <input type="number" id="pre-purchase" placeholder="Auto-calculated" min="0">
      </div>
      <div class="input-group">
        <label>Finance Lease</label>
        <input type="number" id="pre-finance" placeholder="Auto-calculated" min="0">
      </div>
      <div class="input-group">
        <label>Operational Lease</label>
        <input type="number" id="pre-operational" placeholder="Auto-calculated" min="0">
      </div>
    </div>
  </div>

  <div class="btn-group">
    <button class="btn-calculate" onclick="calculate()">Calculate</button>
    <button class="btn-pdf" id="export-pdf" onclick="exportToPDF()" disabled>Export PDF</button>
    <button class="btn-email" id="email-pdf" onclick="emailPDF()" disabled>Send via Email</button>
    <button class="btn-print" onclick="printReport()">Print Report</button>
  </div>

  <div id="error" class="error"></div>

  <div id="results" style="display:none;">
    <h3>Financing Comparison Summary</h3>
    <table id="summary-table">
      <thead>
        <tr>
          <th>Option</th>
          <th>Down Payment</th>
          <th>Monthly Payment</th>
          <th>Total Payments</th>
          <th>Residual Benefit</th>
          <th>Net Cost</th>
          <th>NPV @ <span id="npv-rate"></span>%</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="text-align:center; margin-top:20px; font-weight:bold;" id="recommendation"></p>

    <div class="charts">
      <div class="chart-container"><canvas id="chart-monthly"></canvas></div>
      <div class="chart-container"><canvas id="chart-npv"></canvas></div>
      <div class="chart-container"><canvas id="chart-cumulative"></canvas></div>
      <div class="chart-container"><canvas id="chart-netcost"></canvas></div>
    </div>
  </div>

  <!-- Hidden PDF & Print Content -->
  <div id="pdf-content">
    <div style="text-align:center; margin-bottom:30px;">
      <img src="https://mypieceofcakemove.com/wp-content/uploads/2023/05/Piece-of-Cake-Moving-NYC-Best-Mover-Moving-Company.jpg" width="220" />
      <h2 style="color:#2c3e50; margin:10px 0;">Truck Financing Analysis Report</h2>
      <p style="color:#666;">Generated on <span id="pdf-date"></span></p>
    </div>
    <div id="pdf-table"></div>
    <div style="margin-top:30px; text-align:center; font-weight:bold; font-size:18px;" id="pdf-recommendation"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px;">
      <img id="chart-img-1" />
      <img id="chart-img-2" />
      <img id="chart-img-3" />
      <img id="chart-img-4" />
    </div>
    <div style="margin-top:40px; text-align:center; font-size:12px; color:#666;">
      Â© Piece of Cake Moving & Storage | <a href="https://mypieceofcakemove.com">mypieceofcakemove.com</a>
    </div>
  </div>

  <div id="print-content">
    <style>@media print { body * { visibility: hidden; } #print-content, #print-content * { visibility: visible; } #print-content { position: absolute; left: 0; top: 0; width: 100%; } }</style>
    <div style="padding:20px;">
      <div style="text-align:center;"><img src="https://mypieceofcakemove.com/wp-content/uploads/2023/05/Piece-of-Cake-Moving-NYC-Best-Mover-Moving-Company.jpg" width="200" /></div>
      <h2 style="text-align:center; color:#2c3e50;">Truck Financing Report</h2>
      <div id="print-table"></div>
      <div id="print-charts" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px;"></div>
    </div>
  </div>

  <div class="attribution">
    Powered by <a href="https://mypieceofcakemove.com/" target="_blank">Piece of Cake Moving & Storage</a> | Images Â© Piece of Cake Media Assets
  </div>
</div>

<script>
let charts = {};
let lastResults = {};

// Load from localStorage
window.onload = () => {
  const saved = localStorage.getItem('truckCalc');
  if (saved) {
    const data = JSON.parse(saved);
    Object.keys(data.inputs).forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = data.inputs[id];
    });
    if (data.results) {
      lastResults = data.results;
      renderResults(data.results);
    }
  }
};

function saveToStorage() {
  const inputs = {
    'truck-value': document.getElementById('truck-value').value,
    'term': document.getElementById('term').value,
    'interest-rate': document.getElementById('interest-rate').value,
    'sales-tax': document.getElementById('sales-tax').value,
    'residual': document.getElementById('residual').value,
    'lessor-margin': document.getElementById('lessor-margin').value,
    'residual-benefit': document.getElementById('residual-benefit').value,
    'down-purchase': document.getElementById('down-purchase').value,
    'down-finance': document.getElementById('down-finance').value,
    'down-operational': document.getElementById('down-operational').value,
    'pre-purchase': document.getElementById('pre-purchase').value,
    'pre-finance': document.getElementById('pre-finance').value,
    'pre-operational': document.getElementById('pre-operational').value,
  };
  localStorage.setItem('truckCalc', JSON.stringify({ inputs, results: lastResults }));
}

function calculateMonthlyPayment(principal, rate, periods) {
  if (rate === 0) return principal / periods;
  return (principal * rate * Math.pow(1 + rate, periods)) / (Math.pow(1 + rate, periods) - 1);
}

function calculateNPV(cashFlows, annualRate) {
  const monthlyRate = annualRate / 12;
  return cashFlows.reduce((sum, cf, i) => sum + cf / Math.pow(1 + monthlyRate, i), 0);
}

function calculate() {
  const error = document.getElementById('error');
  const results = document.getElementById('results');
  error.textContent = '';
  results.style.display = 'none';
  document.getElementById('export-pdf').disabled = true;
  document.getElementById('email-pdf').disabled = true;

  // === INPUTS ===
  const truckValue = parseFloat(document.getElementById('truck-value').value);
  const term = parseInt(document.getElementById('term').value);
  const annualRate = parseFloat(document.getElementById('interest-rate').value) / 100;
  const salesTax = parseFloat(document.getElementById('sales-tax').value) / 100;
  const residual = parseFloat(document.getElementById('residual').value);
  const lessorMargin = parseFloat(document.getElementById('lessor-margin').value) / 100;
  const residualBenefit = document.getElementById('residual-benefit').value === 'true';

  const down = {
    purchase: parseFloat(document.getElementById('down-purchase').value) || 0,
    finance_lease: parseFloat(document.getElementById('down-finance').value) || 0,
    operational_lease: parseFloat(document.getElementById('down-operational').value) || 0
  };

  const pre = {
    purchase: document.getElementById('pre-purchase').value ? parseFloat(document.getElementById('pre-purchase').value) : null,
    finance_lease: document.getElementById('pre-finance').value ? parseFloat(document.getElementById('pre-finance').value) : null,
    operational_lease: document.getElementById('pre-operational').value ? parseFloat(document.getElementById('pre-operational').value) : null
  };

  const monthlyRate = annualRate / 12;

  // Validation
  if ([truckValue, term, annualRate, salesTax, residual, lessorMargin].some(v => isNaN(v) || v < 0)) {
    error.textContent = 'All numeric inputs must be non-negative.';
    return;
  }
  if (Object.values(down).some(d => d > truckValue)) {
    error.textContent = 'Down payment cannot exceed truck value.';
    return;
  }

  const options = ['purchase', 'finance_lease', 'operational_lease'];
  const data = {};

  // === CALCULATIONS ===
  options.forEach(opt => {
    let payment, cf = Array(term + 1).fill(0);
    if (pre[opt] !== null) {
      payment = pre[opt];
    } else if (opt === 'purchase') {
      const tax = truckValue * salesTax;
      const loan = truckValue + tax - down[opt];
      if (loan < 0) { error.textContent = 'Down payment exceeds truck + tax.'; return; }
      payment = calculateMonthlyPayment(loan, monthlyRate, term);
    } else if (opt === 'finance_lease') {
      const dep = truckValue - residual - down[opt];
      if (dep < 0) { error.textContent = 'Down payment exceeds depreciable amount.'; return; }
      const base = calculateMonthlyPayment(dep, monthlyRate, term);
      payment = base * (1 + salesTax);
    } else {
      const principal = truckValue - down[opt];
      if (principal < 0) { error.textContent = 'Down payment exceeds truck value.'; return; }
      const leaseRate = monthlyRate + lessorMargin;
      const base = calculateMonthlyPayment(principal, leaseRate, term);
      payment = base * (1 + salesTax);
    }

    cf[0] = -down[opt];
    for (let i = 1; i <= term; i++) cf[i] = -payment;
    if (opt === 'purchase' || (opt === 'finance_lease' && residualBenefit)) cf[term] += residual;
    if (opt === 'finance_lease' && !residualBenefit) cf[term] -= residual;

    const npv = calculateNPV(cf, annualRate);
    data[opt] = { payment, cf, npv, down: down[opt] };
  });

  lastResults = { data, truckValue, term, annualRate, residual, residualBenefit };
  renderResults(lastResults);
  saveToStorage();
}

function renderResults(results) {
  const { data, term, annualRate } = results;
  const options = ['purchase', 'finance_lease', 'operational_lease'];
  const labels = options.map(o => o.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()));

  // Table
  const tbody = document.querySelector('#summary-table tbody');
  tbody.innerHTML = '';
  let bestNPV = Infinity, bestOption = '';

  options.forEach(opt => {
    const d = data[opt];
    const total = d.payment * term + d.down;
    const resBen = (opt !== 'operational_lease' && (opt !== 'finance_lease' || results.residualBenefit)) ? results.residual : 0;
    const net = total - resBen;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${labels[options.indexOf(opt)]}</td>
      <td>$${d.down.toFixed(2)}</td>
      <td>$${d.payment.toFixed(2)}</td>
      <td>$${total.toFixed(2)}</td>
      <td>$${resBen.toFixed(2)}</td>
      <td>$${net.toFixed(2)}</td>
      <td>$${d.npv.toFixed(2)}</td>
    `;
    if (d.npv < bestNPV) { bestNPV = d.npv; bestOption = labels[options.indexOf(opt)]; }
    tbody.appendChild(row);
  });

  Array.from(tbody.rows).forEach(r => { if (r.cells[6].textContent.includes(bestNPV.toFixed(2))) r.classList.add('best'); });
  document.getElementById('npv-rate').textContent = (annualRate * 100).toFixed(1);
  document.getElementById('recommendation').textContent = `Best Option: ${bestOption} (Lowest NPV Cost)`;
  document.getElementById('results').style.display = 'block';
  document.getElementById('export-pdf').disabled = false;
  document.getElementById('email-pdf').disabled = false;

  // Charts
  renderCharts(data, term, labels);
}

function renderCharts(data, term, labels) {
  const ctx1 = document.getElementById('chart-monthly').getContext('2d');
  const ctx2 = document.getElementById('chart-npv').getContext('2d');
  const ctx3 = document.getElementById('chart-cumulative').getContext('2d');
  const ctx4 = document.getElementById('chart-netcost').getContext('2d');

  const colors = ['#2E86AB', '#A23B72', '#F18F01'];
  const monthly = Object.values(data).map(d => d.payment);
  const npv = Object.values(data).map(d => d.npv);
  const netCost = Object.values(data).map((d, i) => {
    const total = d.payment * term + d.down;
    const res = (i === 0 || (i === 1 && lastResults.residualBenefit)) ? lastResults.residual : 0;
    return total - res;
  });

  // Destroy old charts
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  charts.monthly = new Chart(ctx1, { type: 'bar', data: { labels, datasets: [{ label: 'Monthly Payment ($)', data: monthly, backgroundColor: colors }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Monthly Payment' } } } });
  charts.npv = new Chart(ctx2, { type: 'bar', data: { labels, datasets: [{ label: 'NPV ($)', data: npv, backgroundColor: colors }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Net Present Value' } } } });

  const cumData = Object.keys(data).map((opt, i) => {
    const cf = data[opt].cf.map((v, j) => data[opt].cf.slice(0, j + 1).reduce((a, b) => a + b, 0));
    return { label: labels[i], data: cf, borderColor: colors[i], fill: false };
  });
  charts.cumulative = new Chart(ctx3, { type: 'line', data: { labels: Array.from({length: term + 1}, (_, i) => i), datasets: cumData }, options: { responsive: true, plugins: { title: { display: true, text: 'Cumulative Cash Flow' } } } });

  charts.netcost = new Chart(ctx4, { type: 'bar', data: { labels, datasets: [{ label: 'Net Cost ($)', data: netCost, backgroundColor: colors }] }, options: { responsive: true, plugins: { title: { display: true, text: '5-Year Net Cost' } } } });
}

async function exportToPDF() {
  const { jsPDF } = window/jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();

  const content = document.getElementById('pdf-content');
  document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('pdf-table').innerHTML = document.getElementById('summary-table').outerHTML;
  document.getElementById('pdf-recommendation').textContent = document.getElementById('recommendation').textContent;

  // Capture charts
  const chartImgs = await Promise.all([
    charts.monthly.toBase64Image(),
    charts.npv.toBase64Image(),
    charts.cumulative.toBase64Image(),
    charts.netcost.toBase64Image()
  ]);
  ['1','2','3','4'].forEach((n, i) => document.getElementById(`chart-img-${+n}`).src = chartImgs[i]);

  content.style.display = 'block';
  const canvas = await html2canvas(content, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');
  const imgHeight = (canvas.height * pageWidth) / canvas.width;
  pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, imgHeight);
  pdf.save(`Truck_Financing_${new Date().toISOString().split('T')[0]}.pdf`);
  content.style.display = 'none';
}

function emailPDF() {
  exportToPDF().then(() => {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob([/* pdf bytes would go here */], { type: 'application/pdf' }));
    link.download = 'report.pdf';
    const subject = encodeURIComponent('Truck Financing Analysis');
    const body = encodeURIComponent('Please find the financing report attached.');
    window.location.href = `mailto:?subject=${subject}&body=${body}&attachment=${link.href}`;
  });
}

function printReport() {
  const printContent = document.getElementById('print-content');
  printContent.querySelector('#print-table').innerHTML = document.getElementById('summary-table').outerHTML;
  const container = printContent.querySelector('#print-charts');
  container.innerHTML = '';
  Object.values(charts).forEach(chart => {
    const img = document.createElement('img');
    img.src = chart.toBase64Image();
    img.style.width = '100%';
    container.appendChild(img);
  });
  printContent.style.display = 'block';
  window.print();
  printContent.style.display = 'none';
}
</script>

</body>
</html>